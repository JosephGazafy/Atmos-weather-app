name: Atmos Play Store Forge

on:
  push:
    tags:
      - 'p*' # Triggers on play-store tags like p1.0.0
  workflow_dispatch:

jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
    - name: 1. Checkout Source
      uses: actions/checkout@v4

    - name: 2. Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 3. Decode Release Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: echo "$KEYSTORE_BASE64" | base64 --decode > app/atmos.jks

    - name: 4. Build Signed App Bundle (.aab)
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        chmod +x ./gradlew
        ./gradlew bundleRelease --no-daemon

    - name: 5. Upload AAB to GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        files: app/build/outputs/bundle/release/*.aab
        name: Atmos Play Store Bundle ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
