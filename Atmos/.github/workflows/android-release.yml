name: Atmos Unitary Forge

on:
  push:
    tags:
      - 'v*'         # Triggers on version tags like v1.0.0
  workflow_dispatch: # Allows you to trigger the build manually

jobs:
  forge:
    runs-on: ubuntu-latest
    env:
      RELEASE_STORE_FILE: atmos.jks
    
    steps:
    - name: 1. Checkout Sovereign Source
      uses: actions/checkout@v4

    - name: 2. Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 3. Cache Gradle Build State
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    - name: 4. Decode Sovereign Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo "$KEYSTORE_BASE64" | base64 --decode > app/$RELEASE_STORE_FILE

    - name: 5. Build and Sign Signed APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        chmod +x ./gradlew
        ./gradlew assembleRelease --no-daemon

    - name: 6. Locate Artifact
      id: find_apk
      run: |
        APK_PATH=$(find app/build/outputs/apk/release/ -name "*.apk" | head -n 1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

    - name: 7. Create GitHub Release
      id: create_release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.find_apk.outputs.apk_path }}
        name: Atmos Core Release ${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

